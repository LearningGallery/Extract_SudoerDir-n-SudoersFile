---
- name: Ensure local temporary directory exists on AAP control node
  ansible.builtin.file:
    path: "{{ local_temp_dir }}"
    state: directory
    mode: '0700'
  delegate_to: localhost
  run_once: yes

- name: Archive sudoers file and sudoers.d directory on RHEL machine
  ansible.builtin.archive:
    path:
      - /etc/sudoers
      - /etc/sudoers.d/
    dest: "/tmp/{{ backup_filename }}"
    format: gz
  become: yes

- name: Fetch sudoers archive to AAP server
  ansible.builtin.fetch:
    src: "/tmp/{{ backup_filename }}"
    dest: "{{ local_temp_dir }}/"
    flat: yes
  become: yes

- name: Clean up remote archive on RHEL machine
  ansible.builtin.file:
    path: "/tmp/{{ backup_filename }}"
    state: absent
  become: yes