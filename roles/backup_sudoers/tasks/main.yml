---
- name: Ensure local temporary directory exists on control node
  ansible.builtin.file:
    path: "{{ local_temp_dir }}"
    state: directory
    mode: '0700'
  delegate_to: localhost
  run_once: yes
  become: no

- name: Set timestamp fact for file naming (Date and Time)
  ansible.builtin.set_fact:
    # Formats as YYYY-MM-DD_HH-MM-SS (e.g., 2026-02-26_16-14-26)
    backup_timestamp: "{{ ansible_date_time.date }}_{{ ansible_date_time.time | replace(':', '-') }}"

- name: Archive sudoers file and sudoers.d directory on RHEL machine
  ansible.builtin.archive:
    path:
      - /etc/sudoers
      - /etc/sudoers.d/
    dest: "/tmp/{{ inventory_hostname }}_{{ backup_timestamp }}_sudoers_backup.tar.gz"
    format: gz
  become: yes

- name: Fetch sudoers archive to control node
  ansible.builtin.fetch:
    src: "/tmp/{{ inventory_hostname }}_{{ backup_timestamp }}_sudoers_backup.tar.gz"
    dest: "{{ local_temp_dir }}/"
    flat: yes
  become: yes

- name: Upload sudoers archive to Azure Blob Storage
  azure.azcollection.azure_rm_storageblob:
    resource_group: "{{ az_resource_group }}"
    storage_account_name: "{{ az_storage_account }}"
    container: "{{ az_container }}"
    blob: "{{ inventory_hostname }}_{{ backup_timestamp }}_sudoers_backup.tar.gz"
    src: "{{ local_temp_dir }}/{{ inventory_hostname }}_{{ backup_timestamp }}_sudoers_backup.tar.gz"
  delegate_to: localhost
  become: no

- name: Clean up remote archive on RHEL machine
  ansible.builtin.file:
    path: "/tmp/{{ inventory_hostname }}_{{ backup_timestamp }}_sudoers_backup.tar.gz"
    state: absent
  become: yes

- name: Clean up local temporary file from control node
  ansible.builtin.file:
    path: "{{ local_temp_dir }}/{{ inventory_hostname }}_{{ backup_timestamp }}_sudoers_backup.tar.gz"
    state: absent
  delegate_to: localhost
  become: no